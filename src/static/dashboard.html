<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Service Bot ‚Äî Owner Dashboard</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f0f2f5;
      color: #1a1a2e;
      min-height: 100vh;
    }

    header {
      background: #075e54;
      color: #fff;
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    header h1 { font-size: 1.2rem; font-weight: 600; }
    header .subtitle { font-size: 0.8rem; opacity: 0.75; margin-top: 2px; }
    #last-updated { font-size: 0.75rem; opacity: 0.7; }

    main { max-width: 1200px; margin: 0 auto; padding: 24px 16px; }

    /* ‚îÄ‚îÄ Login ‚îÄ‚îÄ */
    #login-screen {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 80vh;
    }
    .login-card {
      background: #fff;
      border-radius: 16px;
      padding: 40px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 400px;
      text-align: center;
    }
    .login-card h2 { margin-bottom: 8px; color: #075e54; }
    .login-card p { color: #666; font-size: 0.9rem; margin-bottom: 24px; }
    .login-card input {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 0.95rem;
      margin-bottom: 12px;
    }
    .login-card input:focus { outline: 2px solid #075e54; border-color: transparent; }
    #login-error { color: #e74c3c; font-size: 0.85rem; margin-bottom: 12px; display: none; }

    /* ‚îÄ‚îÄ Stats Cards ‚îÄ‚îÄ */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 16px;
      margin-bottom: 28px;
    }
    .stat-card {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
      text-align: center;
    }
    .stat-card .value { font-size: 2.4rem; font-weight: 700; line-height: 1; }
    .stat-card .label { font-size: 0.78rem; color: #666; margin-top: 6px; text-transform: uppercase; letter-spacing: 0.05em; }
    .stat-card.pending   .value { color: #e67e22; }
    .stat-card.confirmed .value { color: #27ae60; }
    .stat-card.handoff   .value { color: #e74c3c; }
    .stat-card.chats     .value { color: #2980b9; }
    .stat-card.total     .value { color: #6c5ce7; }
    .stat-card.done      .value { color: #95a5a6; }

    /* ‚îÄ‚îÄ Section ‚îÄ‚îÄ */
    section { margin-bottom: 32px; }
    section h2 {
      font-size: 1rem;
      font-weight: 600;
      color: #444;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    section h2 .count {
      background: #075e54;
      color: #fff;
      font-size: 0.72rem;
      padding: 2px 8px;
      border-radius: 999px;
    }

    /* ‚îÄ‚îÄ Table ‚îÄ‚îÄ */
    .table-wrap { overflow-x: auto; border-radius: 12px; box-shadow: 0 1px 4px rgba(0,0,0,0.08); }
    table { width: 100%; border-collapse: collapse; background: #fff; }
    th {
      background: #f8f9fa;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #888;
      padding: 10px 14px;
      text-align: left;
      border-bottom: 1px solid #eee;
      white-space: nowrap;
    }
    td {
      padding: 12px 14px;
      border-bottom: 1px solid #f0f0f0;
      font-size: 0.88rem;
      vertical-align: middle;
    }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: #fafafa; }

    /* ‚îÄ‚îÄ Badges ‚îÄ‚îÄ */
    .badge {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 999px;
      font-size: 0.72rem;
      font-weight: 600;
      white-space: nowrap;
    }
    .badge-pending   { background: #fff3e0; color: #e67e22; }
    .badge-confirmed { background: #e8f5e9; color: #27ae60; }
    .badge-done      { background: #eceff1; color: #607d8b; }
    .badge-urgent    { background: #fdecea; color: #e74c3c; }
    .badge-menu      { background: #e3f2fd; color: #1565c0; }
    .badge-ai        { background: #f3e5f5; color: #7b1fa2; }
    .badge-handoff   { background: #fdecea; color: #c62828; }
    .badge-intake    { background: #e8f5e9; color: #2e7d32; }

    /* ‚îÄ‚îÄ Status Select ‚îÄ‚îÄ */
    select.status-select {
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 4px 8px;
      font-size: 0.82rem;
      cursor: pointer;
      background: #fff;
    }
    select.status-select:focus { outline: 2px solid #075e54; }

    /* ‚îÄ‚îÄ Conversations list ‚îÄ‚îÄ */
    .conv-list { display: flex; flex-direction: column; gap: 10px; }
    .conv-item {
      background: #fff;
      border-radius: 10px;
      padding: 14px 16px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.07);
      display: flex;
      align-items: center;
      gap: 14px;
    }
    .conv-item .phone { font-weight: 600; font-size: 0.9rem; flex: 1; }
    .conv-item .time  { font-size: 0.75rem; color: #999; }

    /* ‚îÄ‚îÄ Button ‚îÄ‚îÄ */
    .btn {
      background: #075e54;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 8px 16px;
      font-size: 0.85rem;
      cursor: pointer;
      font-weight: 500;
    }
    .btn:hover { background: #054d44; }

    /* ‚îÄ‚îÄ Empty state ‚îÄ‚îÄ */
    .empty { text-align: center; padding: 32px; color: #aaa; font-size: 0.9rem; }

    /* ‚îÄ‚îÄ Refresh indicator ‚îÄ‚îÄ */
    #refresh-bar {
      height: 3px;
      background: #25d366;
      width: 0%;
      transition: width 30s linear;
      position: fixed;
      top: 0;
      left: 0;
    }

    .hidden { display: none !important; }
  </style>
</head>
<body>

<div id="refresh-bar"></div>

<!-- Login Screen -->
<div id="login-screen">
  <div class="login-card">
    <h2>Service Bot</h2>
    <p>Sign in to your dashboard</p>
    <div id="login-error"></div>
    <input type="email" id="login-email" placeholder="Email" autocomplete="email" />
    <input type="password" id="login-password" placeholder="Password" autocomplete="current-password" />
    <button class="btn" style="width:100%;padding:12px;font-size:1rem;margin-top:8px" onclick="doLogin()">Sign In</button>
  </div>
</div>

<!-- Dashboard (hidden until logged in) -->
<div id="dashboard" class="hidden">
  <header>
    <div>
      <h1>üìã Owner Dashboard</h1>
      <div class="subtitle" id="tenant-name">WhatsApp Service Bot</div>
    </div>
    <div style="display:flex;align-items:center;gap:12px;">
      <span id="last-updated">Loading‚Ä¶</span>
      <button class="btn" onclick="loadAll()">‚Üª Refresh</button>
      <button class="btn" style="background:#25d366" onclick="sendDigest()">üì§ Send Digest Now</button>
      <button class="btn" style="background:#e74c3c" onclick="doLogout()">Logout</button>
    </div>
  </header>

  <main>
    <div class="stats-grid">
      <div class="stat-card total">
        <div class="value" id="stat-total">‚Äî</div>
        <div class="label">Total Jobs</div>
      </div>
      <div class="stat-card pending">
        <div class="value" id="stat-pending">‚Äî</div>
        <div class="label">Pending</div>
      </div>
      <div class="stat-card confirmed">
        <div class="value" id="stat-confirmed">‚Äî</div>
        <div class="label">Confirmed</div>
      </div>
      <div class="stat-card done">
        <div class="value" id="stat-done">‚Äî</div>
        <div class="label">Done</div>
      </div>
      <div class="stat-card chats">
        <div class="value" id="stat-chats">‚Äî</div>
        <div class="label">Active Chats</div>
      </div>
      <div class="stat-card handoff">
        <div class="value" id="stat-handoff">‚Äî</div>
        <div class="label">Awaiting Reply</div>
      </div>
    </div>

    <section>
      <h2>üîß Jobs <span class="count" id="jobs-count">0</span></h2>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Service</th>
              <th>Customer</th>
              <th>Problem</th>
              <th>Address</th>
              <th>Quote</th>
              <th>Urgent</th>
              <th>Scheduled</th>
              <th>Status</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody id="jobs-tbody">
            <tr><td colspan="9" class="empty">Loading‚Ä¶</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <section>
      <h2>üí¨ Active Conversations <span class="count" id="convs-count">0</span></h2>
      <div class="conv-list" id="convs-list">
        <div class="empty">Loading‚Ä¶</div>
      </div>
    </section>
  </main>
</div>

<script>
// ‚îÄ‚îÄ Auth ‚îÄ‚îÄ
let authToken = localStorage.getItem('jwt');
let tenantInfo = null;

function authHeaders() {
  return authToken ? { 'Authorization': `Bearer ${authToken}` } : {};
}

async function authFetch(url, opts = {}) {
  const headers = { ...authHeaders(), ...(opts.headers || {}) };
  const res = await fetch(url, { ...opts, headers });
  if (res.status === 401) {
    doLogout();
    throw new Error('Unauthorized');
  }
  return res;
}

async function doLogin() {
  const email = document.getElementById('login-email').value;
  const password = document.getElementById('login-password').value;
  const errEl = document.getElementById('login-error');
  errEl.style.display = 'none';

  try {
    const res = await fetch('/api/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password }),
    });
    const data = await res.json();
    if (!res.ok) {
      errEl.textContent = data.error || 'Login failed';
      errEl.style.display = 'block';
      return;
    }
    authToken = data.token;
    tenantInfo = data.tenant;
    localStorage.setItem('jwt', authToken);
    showDashboard();
  } catch {
    errEl.textContent = 'Connection error';
    errEl.style.display = 'block';
  }
}

function doLogout() {
  authToken = null;
  tenantInfo = null;
  localStorage.removeItem('jwt');
  document.getElementById('login-screen').classList.remove('hidden');
  document.getElementById('dashboard').classList.add('hidden');
}

function showDashboard() {
  document.getElementById('login-screen').classList.add('hidden');
  document.getElementById('dashboard').classList.remove('hidden');
  if (tenantInfo) {
    document.getElementById('tenant-name').textContent = tenantInfo.name;
  }
  loadAll();
}

// ‚îÄ‚îÄ Check if already logged in ‚îÄ‚îÄ
if (authToken) {
  // Verify token is still valid
  authFetch('/api/stats').then(res => {
    if (res.ok) showDashboard();
    else doLogout();
  }).catch(() => doLogout());
} else {
  document.getElementById('login-screen').classList.remove('hidden');
}

// ‚îÄ‚îÄ Enter key for login form ‚îÄ‚îÄ
document.getElementById('login-password').addEventListener('keydown', (e) => {
  if (e.key === 'Enter') doLogin();
});

// ‚îÄ‚îÄ Dashboard Logic ‚îÄ‚îÄ
const STATE_BADGE = {
  MENU:           'badge-menu',
  SERVICE_SELECT: 'badge-menu',
  INTAKE:         'badge-intake',
  CONFIRM:        'badge-intake',
  AI_CHAT:        'badge-ai',
  HANDOFF:        'badge-handoff',
  DONE:           'badge-done',
};

function fmt(state) {
  const labels = {
    MENU: 'Menu', SERVICE_SELECT: 'Selecting Service',
    INTAKE: 'Intake', CONFIRM: 'Confirming', AI_CHAT: 'AI Chat',
    HANDOFF: '‚ö†Ô∏è Handoff', DONE: 'Done',
  };
  return labels[state] || state;
}

function timeAgo(dateStr) {
  const diff = Date.now() - new Date(dateStr).getTime();
  const m = Math.floor(diff / 60000);
  if (m < 1) return 'just now';
  if (m < 60) return `${m}m ago`;
  const h = Math.floor(m / 60);
  if (h < 24) return `${h}h ago`;
  return `${Math.floor(h / 24)}d ago`;
}

async function loadStats() {
  const data = await authFetch('/api/stats').then(r => r.json());
  document.getElementById('stat-total').textContent     = data.totalJobs;
  document.getElementById('stat-pending').textContent   = data.pendingJobs;
  document.getElementById('stat-confirmed').textContent = data.confirmedJobs;
  document.getElementById('stat-done').textContent      = data.doneJobs;
  document.getElementById('stat-chats').textContent     = data.activeConversations;
  document.getElementById('stat-handoff').textContent   = data.openHandoffs;
}

async function loadJobs() {
  const jobs = await authFetch('/api/jobs').then(r => r.json());
  const tbody = document.getElementById('jobs-tbody');
  document.getElementById('jobs-count').textContent = jobs.length;

  if (!jobs.length) {
    tbody.innerHTML = '<tr><td colspan="9" class="empty">No jobs yet</td></tr>';
    return;
  }

  tbody.innerHTML = jobs.map(j => `
    <tr>
      <td>${j.serviceType}</td>
      <td>
        <div style="font-weight:600">${j.customer?.name || '‚Äî'}</div>
        <div style="font-size:0.75rem;color:#888">${j.customer?.phone || ''}</div>
      </td>
      <td style="max-width:200px;white-space:normal">${j.description}</td>
      <td style="max-width:180px;white-space:normal">${j.address}</td>
      <td>${j.quoteMin != null ? `¬£${j.quoteMin}‚Äì¬£${j.quoteMax}` : '‚Äî'}</td>
      <td>${j.urgent ? '<span class="badge badge-urgent">üö® Yes</span>' : '‚Äî'}</td>
      <td style="white-space:nowrap;font-size:0.82rem">
        ${j.scheduledAt
          ? `<div>${new Date(j.scheduledAt).toLocaleDateString('en-GB', {weekday:'short',day:'numeric',month:'short'})}</div>
             <div style="color:#888">${new Date(j.scheduledAt).toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit',hour12:true})}</div>
             ${j.calendarLink ? `<a href="${j.calendarLink}" target="_blank" style="font-size:0.72rem;color:#075e54">üìÖ View</a>` : ''}`
          : '‚Äî'}
      </td>
      <td>
        <select class="status-select" data-id="${j.id}" onchange="updateStatus('${j.id}', this.value)">
          <option value="PENDING"   ${j.status==='PENDING'   ? 'selected' : ''}>Pending</option>
          <option value="CONFIRMED" ${j.status==='CONFIRMED' ? 'selected' : ''}>Confirmed</option>
          <option value="DONE"      ${j.status==='DONE'      ? 'selected' : ''}>Done</option>
        </select>
      </td>
      <td style="white-space:nowrap;font-size:0.78rem;color:#888">${timeAgo(j.createdAt)}</td>
    </tr>
  `).join('');
}

async function loadConversations() {
  const convs = await authFetch('/api/conversations').then(r => r.json());
  const active = convs.filter(c => c.state !== 'DONE');
  document.getElementById('convs-count').textContent = active.length;
  const list = document.getElementById('convs-list');

  if (!active.length) {
    list.innerHTML = '<div class="empty">No active conversations</div>';
    return;
  }

  list.innerHTML = active.map(c => `
    <div class="conv-item">
      <div class="phone">${c.customer?.phone || 'Unknown'}</div>
      <span class="badge ${STATE_BADGE[c.state] || ''}">${fmt(c.state)}</span>
      <div class="time">${timeAgo(c.updatedAt)}</div>
    </div>
  `).join('');
}

async function updateStatus(id, status) {
  await authFetch(`/api/jobs/${id}/status`, {
    method: 'PATCH',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ status }),
  });
  await loadStats();
}

async function sendDigest() {
  const btn = event.target;
  btn.disabled = true;
  btn.textContent = 'Sending‚Ä¶';
  try {
    await authFetch('/api/test-digest');
    btn.textContent = '‚úÖ Sent!';
    setTimeout(() => { btn.disabled = false; btn.textContent = 'üì§ Send Digest Now'; }, 3000);
  } catch {
    btn.textContent = '‚ùå Error';
    btn.disabled = false;
  }
}

async function loadAll() {
  try {
    await Promise.all([loadStats(), loadJobs(), loadConversations()]);
    document.getElementById('last-updated').textContent =
      'Updated ' + new Date().toLocaleTimeString();
    startProgressBar();
  } catch { /* logged out */ }
}

function startProgressBar() {
  const bar = document.getElementById('refresh-bar');
  bar.style.transition = 'none';
  bar.style.width = '0%';
  requestAnimationFrame(() => {
    bar.style.transition = 'width 30s linear';
    bar.style.width = '100%';
  });
}

// Auto-refresh every 30s (only when dashboard is visible)
setInterval(() => {
  if (authToken && !document.getElementById('dashboard').classList.contains('hidden')) {
    loadAll();
  }
}, 30000);
</script>
</body>
</html>
